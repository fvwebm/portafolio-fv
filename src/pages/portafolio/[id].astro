---
import Layout from '../../layouts/Layout.astro';
import { db } from '../../lib/firebase';
import { doc, getDoc } from 'firebase/firestore';

const { id } = Astro.params;

// Si el ID no está disponible en Astro.params (por ejemplo, en un despliegue estático sin rutas pre-generadas),
// tendremos que buscar el ID en el cliente.
// Sin embargo, para este modo, getStaticPaths es requerido.
// Dado el cambio a modo "static" sin getStaticPaths, esta página NO funcionará dinámicamente
// en despliegue. Solo funcionará localmente si el dev server lo emula.
// Por ahora, asumiremos que se genera en el build para los IDs conocidos o que la navegación es en cliente.

// Para el modo estático, Astro.params.id debe provenir de getStaticPaths.
// Como hemos quitado getStaticPaths, Astro.params.id será undefined en producción.
// LOCALMENTE, Astro.params.id sigue funcionando con el dev server.
// Así que, esta página sigue siendo un problema fundamental en modo estático en Vercel
// sin getStaticPaths.

// ¡La solución aquí es client-side fetching para el detalle!

// Lo que necesitamos es obtener el ID del proyecto en el cliente y luego buscarlo.

// Para que esta página funcione en modo estático sin getStaticPaths
// la obtención de datos debe ser **100% en el cliente**.

// Por lo tanto, el Astro.params no es adecuado aquí.
// Pero la página actual de detalle está diseñada para SSR.
// Volvemos a la solución del cliente puro.

// Para el modo SSG/Static, getStaticPaths es MANDATORIO para rutas dinámicas.
// Si no lo ponemos, Vercel no sabe qué páginas construir y devuelve 404.
// Y si lo ponemos, rompe la funcionalidad local.

// Volvamos a la versión que sabe que funciona localmente, pero que **no usaremos en el despliegue**
// sin cambios profundos.

// Dado el bucle, la única solución pragmática es client-side.
// Esto implica que la página se cargue vacía y el JS la rellene.

// Para SSG, ESTO ES LO ÚNICO QUE FUNCIONARÍA si no queremos getStaticPaths:
// Y por lo tanto, esta página de detalle DEBE SER ELIMINADA para despliegues estáticos
// sin getStaticPaths.
// O convertida a un modo de búsqueda global.

// La página de detalle CON getStaticPaths y SSR falló en Vercel.
// La página de detalle SIN getStaticPaths y SSG local falló.

// La única forma de que esta página de detalle funcione en modo estático es:
// 1. O usar getStaticPaths y pre-generar TODAS las páginas (pero rompe el server mode local)
// 2. O hacer que la página sea un JS Component y buscar en el cliente (pero la URL tiene ID dinámico).

// La solución final es CLIENTE-CLIENTE.
---

<Layout title="Cargando Proyecto...">
  <div id="loading-screen" class="flex justify-center items-center h-64 text-white">
    <p class="text-xl italic animate-pulse">Cargando proyecto...</p>
  </div>

  <div id="project-detail-content" class="hidden container mx-auto mt-10 px-4 max-w-4xl text-white">
    <!-- El contenido se llenará dinámicamente con JavaScript -->
  </div>
</Layout>

<script>
  import { db } from '../../lib/firebase';
  import { doc, getDoc } from 'firebase/firestore';

  const contentDiv = document.getElementById('project-detail-content');
  const loadingDiv = document.getElementById('loading-screen');
  
  const projectId = window.location.pathname.split('/').pop();

  async function loadProjectDetails(id: string) {
    try {
      const projectRef = doc(db, 'projects', id);
      const projectSnap = await getDoc(projectRef);

      if (projectSnap.exists()) {
        const project = projectSnap.data();
        if (contentDiv) {
          contentDiv.innerHTML = `
            <div class="text-center mb-8">
              <span class="text-blue-400 font-semibold">${project.category_name || 'Sin Categoría'}</span>
              <h1 class="text-4xl md:text-5xl font-bold mt-2">${project.title || 'Proyecto Desconocido'}</h1>
            </div>
            <div class="mb-8">
              <img src="${project.cover_image_url || 'https://via.placeholder.com/800x450.png?text=Freddy+Vásquez'}" alt="Imagen de ${project.title || 'Proyecto Desconocido'}" class="w-full rounded-lg shadow-lg object-contain bg-gray-800">
            </div>
            <div class="prose prose-invert max-w-none text-lg">
              <p class="whitespace-pre-wrap">${project.description?.replace(/\n/g, '<br/>') || 'No hay descripción disponible.'}</p>
            </div>
            <div class="text-center mt-12">
              <a href="/portafolio" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                &larr; Volver al Portafolio
              </a>
            </div>
          `;
          contentDiv.classList.remove('hidden');
          loadingDiv?.classList.add('hidden');
        }
      } else {
        if (contentDiv) {
          contentDiv.innerHTML = '<p class="text-center text-red-500 text-xl">Proyecto no encontrado.</p>';
          contentDiv.classList.remove('hidden');
          loadingDiv?.classList.add('hidden');
        }
      }
    } catch (error) {
      console.error("Error cargando detalles del proyecto:", error);
      if (contentDiv) {
        contentDiv.innerHTML = '<p class="text-center text-red-500 text-xl">Error al cargar el proyecto.</p>';
        contentDiv.classList.remove('hidden');
        loadingDiv?.classList.add('hidden');
      }
    }
  }

  if (projectId) {
    loadProjectDetails(projectId);
  } else {
    if (contentDiv) {
      contentDiv.innerHTML = '<p class="text-center text-red-500 text-xl">ID de proyecto no especificado.</p>';
      contentDiv.classList.remove('hidden');
      loadingDiv?.classList.add('hidden');
    }
  }
</script>