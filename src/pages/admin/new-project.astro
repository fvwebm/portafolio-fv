---
import Layout from '../../layouts/Layout.astro';
import { db } from '../../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';

// Protección de ruta
if (!Astro.cookies.has('user-session')) {
  return Astro.redirect('/admin/login');
}

// ¡NUEVA LÓGICA! Obtenemos las categorías para el menú desplegable
type Category = {
  id: string;
  name: string;
}
const categoriesCol = collection(db, 'categories');
const categoriesSnapshot = await getDocs(categoriesCol);
const categories: Category[] = categoriesSnapshot.docs.map(doc => ({
  id: doc.id,
  ...doc.data()
} as Category));
---

<Layout title="Nuevo Proyecto">
  <div class="container mx-auto mt-10 px-4">
    <h1 class="text-4xl font-bold mb-6">Añadir Nuevo Proyecto</h1>
    
    <form id="new-project-form" class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-2xl mx-auto">
      
      <div class="mb-4">
        <label for="title" class="block mb-2">Título del Proyecto</label>
        <input type="text" id="title" name="title" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:border-blue-500" required />
      </div>

      <div class="mb-4">
        <label for="category" class="block mb-2">Categoría</label>
        <select id="category" name="category" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:border-blue-500" required>
          <option value="">-- Selecciona una categoría --</option>
          {categories.map(category => (
            <option value={category.name}>{category.name}</option>
          ))}
        </select>
      </div>

      <div class="mb-4">
        <label for="description" class="block mb-2">Descripción</label>
        <textarea id="description" name="description" rows="4" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:border-blue-500"></textarea>
      </div>

      <div class="mb-4">
        <label for="cover_image_url" class="block mb-2">URL de la Imagen de Portada</label>
        <input type="text" id="cover_image_url" name="cover_image_url" class="w-full p-2 rounded bg-gray-700 border border-gray-600" />
      </div>
      
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Guardar Proyecto
      </button>

      <p id="success-message" class="text-green-500 text-center mt-4"></p>
      <p id="error-message" class="text-red-500 text-center mt-4"></p>
    </form>
  </div>
</Layout>

<script>
  import { db } from '../../lib/firebase';
  import { collection, addDoc, serverTimestamp } from 'firebase/firestore';

  const form = document.getElementById('new-project-form');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    successMessage.textContent = '';
    errorMessage.textContent = '';

    const formData = new FormData(form);
    const title = formData.get('title') as string;
    const category_name = formData.get('category') as string;
    const description = formData.get('description') as string;
    const cover_image_url = formData.get('cover_image_url') as string;

    try {
      await addDoc(collection(db, 'projects'), {
        title,
        category_name,
        description,
        cover_image_url,
        published_at: serverTimestamp()
      });
      
      successMessage.textContent = '¡Proyecto guardado con éxito!';
      form.reset();

    } catch (error) {
      console.error("Error al guardar el proyecto:", error);
      errorMessage.textContent = 'Hubo un error al guardar el proyecto.';
    }
  });
</script>