---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Nuevo Proyecto">
  <div id="loading-screen" class="flex justify-center items-center h-64 text-white">
    <p class="text-xl italic animate-pulse">Verificando sesión...</p>
  </div>

  <div id="admin-content" class="hidden container mx-auto mt-10 px-4 text-white">
    <h1 class="text-4xl font-bold mb-6 text-center">Añadir Nuevo Proyecto</h1>
    <form id="new-project-form" class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-2xl mx-auto border border-gray-700">
      <div class="mb-4">
        <label class="block mb-2">Título del Proyecto</label>
        <input type="text" id="title" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white outline-none focus:border-blue-500" required />
      </div>
      <div class="mb-4">
        <label class="block mb-2">Categoría</label>
        <select id="category-select" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white outline-none focus:border-blue-500" required>
          <option value="">Cargando categorías...</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block mb-2">Descripción</label>
        <textarea id="description" rows="4" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white outline-none focus:border-blue-500"></textarea>
      </div>
      <div class="mb-4">
        <label class="block mb-2">URL de la Imagen</label>
        <input type="text" id="cover_image_url" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white outline-none focus:border-blue-500" />
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Guardar Proyecto</button>
    </form>
  </div>
</Layout>

<script>
  import { auth, db } from '../../lib/firebase';
  import { onAuthStateChanged } from 'firebase/auth';
  import { collection, getDocs, addDoc, serverTimestamp } from 'firebase/firestore';

  const content = document.getElementById('admin-content');
  const loading = document.getElementById('loading-screen');
  const select = document.getElementById('category-select');

  onAuthStateChanged(auth, (user) => {
    if (user) {
      content.classList.remove('hidden');
      loading.classList.add('hidden');
      loadCategories();
    } else {
      window.location.href = '/admin/login';
    }
  });

  async function loadCategories() {
    const snap = await getDocs(collection(db, 'categories'));
    select.innerHTML = '<option value="">-- Selecciona --</option>';
    snap.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.data().name;
      opt.textContent = d.data().name;
      select.appendChild(opt);
    });
  }

  document.getElementById('new-project-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await addDoc(collection(db, 'projects'), {
      title: document.getElementById('title').value,
      category_name: select.value,
      description: document.getElementById('description').value,
      cover_image_url: document.getElementById('cover_image_url').value,
      published_at: serverTimestamp()
    });
    window.location.href = '/admin';
  });
</script>