---
import Layout from '../../../layouts/Layout.astro';
import { db } from '../../../lib/firebase';
import { doc, getDoc, collection, getDocs } from 'firebase/firestore';

// Protección de ruta
if (!Astro.cookies.has('user-session')) {
  return Astro.redirect('/admin/login');
}

// 1. Obtenemos el ID del proyecto desde la URL
const { id } = Astro.params;

// 2. Obtenemos los datos de ESE proyecto específico
const projectRef = doc(db, 'projects', id);
const projectSnap = await getDoc(projectRef);

if (!projectSnap.exists()) {
  // Si el proyecto no existe, mostramos un error 404
  return new Response(null, { status: 404, statusText: 'Not Found' });
}
const projectData = projectSnap.data();

// 3. Obtenemos las categorías para el menú desplegable (igual que en new-project)
type Category = { id: string; name: string; }
const categoriesCol = collection(db, 'categories');
const categoriesSnapshot = await getDocs(categoriesCol);
const categories: Category[] = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Category));
---

<Layout title={`Editando: ${projectData.title}`}>
  <div class="container mx-auto mt-10 px-4">
    <h1 class="text-4xl font-bold mb-6">Editando Proyecto</h1>
    
    <form id="edit-project-form" class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-2xl mx-auto">
      
      <div class="mb-4">
        <label for="title" class="block mb-2">Título del Proyecto</label>
        <input type="text" id="title" name="title" value={projectData.title} class="w-full p-2 rounded bg-gray-700 border border-gray-600" required />
      </div>

      <div class="mb-4">
        <label for="category" class="block mb-2">Categoría</label>
        <select id="category" name="category" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
          {categories.map(category => (
            <option value={category.name} selected={projectData.category_name === category.name}>{category.name}</option>
          ))}
        </select>
      </div>

      <div class="mb-4">
        <label for="description" class="block mb-2">Descripción</label>
        <textarea id="description" name="description" rows="4" class="w-full p-2 rounded bg-gray-700 border border-gray-600">{projectData.description}</textarea>
      </div>

      <div class="mb-4">
        <label for="cover_image_url" class="block mb-2">URL de la Imagen de Portada</label>
        <input type="text" id="cover_image_url" name="cover_image_url" value={projectData.cover_image_url || ''} class="w-full p-2 rounded bg-gray-700 border border-gray-600" />
      </div>
      
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Actualizar Proyecto
      </button>

      <p id="success-message" class="text-green-500 text-center mt-4"></p>
    </form>
  </div>
</Layout>

<script>
  import { db } from '../../../lib/firebase';
  import { doc, updateDoc } from 'firebase/firestore';

  const form = document.getElementById('edit-project-form');
  const successMessage = document.getElementById('success-message');
  
  const projectId = window.location.pathname.split('/').pop();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    successMessage.textContent = '';

    const formData = new FormData(form);
    const updatedData = {
      title: formData.get('title'),
      category_name: formData.get('category'),
      description: formData.get('description'),
      cover_image_url: formData.get('cover_image_url'),
    };

    try {
      const projectRef = doc(db, 'projects', projectId);
      await updateDoc(projectRef, updatedData);
      
      successMessage.textContent = '¡Proyecto actualizado con éxito!';
    } catch (error) {
      console.error("Error al actualizar el proyecto:", error);
      alert('Hubo un error al actualizar el proyecto.');
    }
  });
</script>